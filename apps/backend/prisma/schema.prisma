generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Prompt {
  id          String   @id @default(uuid())
  name        String   @unique
  content     String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  testCases   TestCase[]

  @@map("prompts")
}

model TestCase {
  id              String   @id @default(uuid())
  name            String
  description     String?
  promptId        String
  initialContext  String?  // JSON string
  memory          String?  // JSON string
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  prompt          Prompt         @relation(fields: [promptId], references: [id], onDelete: Cascade)
  steps           TestStep[]
  mocks           Mock[]
  executions      TestExecution[]

  @@map("test_cases")
}

model TestStep {
  id               String   @id @default(uuid())
  testCaseId       String
  stepOrder        Int
  userInput        String?
  message          String?
  input            String?  // JSON string
  expectedBehavior String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  testCase         TestCase @relation(fields: [testCaseId], references: [id], onDelete: Cascade)

  @@map("test_steps")
}

model Mock {
  id          String   @id @default(uuid())
  testCaseId  String
  name        String
  code        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  testCase    TestCase @relation(fields: [testCaseId], references: [id], onDelete: Cascade)

  @@map("mocks")
  @@unique([testCaseId, name])
}

model TestExecution {
  id          String   @id @default(uuid())
  testCaseId  String
  model       String
  judgeModel  String
  status      String   // PENDING, RUNNING, COMPLETED, FAILED
  startedAt   DateTime @default(now())
  completedAt DateTime?
  errorMessage String?
  
  testCase    TestCase       @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
  results     StepResult[]

  @@map("test_executions")
}

model StepResult {
  id              String   @id @default(uuid())
  executionId     String
  stepOrder       Int
  userInput       String
  renderedPrompt  String?
  actualResponse  String
  passed          Boolean
  score           Int
  feedback        String
  toolExecutions  String?  // JSON array of tool calls: [{toolName, arguments, result, timestamp}]
  createdAt       DateTime @default(now())
  
  execution       TestExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@map("step_results")
}
